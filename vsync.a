	processor 6502
	include "vcs.h"
	include "macro.h"

	SEG.U RAM_VARS
	ORG $80
        
BlueX	ds 1
PinkX	ds 1
BlueRem	ds 1
PinkRem	ds 1

;	= $86
PinkCtr ds 1
PinkVel ds 1
PinkIdx ds 1

BlueCtr ds 1
BlueVel ds 1
BlueIdx ds 1

BluePad ds 1
PinkPad ds 1

Time	ds 2


; CODE
	SEG
	org  $f000


SongDataPinkVel
	.byte $10, $20, $00, $D0, $E0, $20
SongDataPinkTimes
        .byte 10, 30, 25, 10, 12

SongDataBlueVel
	.byte $00, $F0, $00, $F0, $10, $10
SongDataBlueTimes
        .byte 50, 30, 10, 40, 12

    MAC SET_SPRT
    	sta WSYNC
        SLEEP 14
	lda {3}
	sec   
.loop
        sbc #15
        bcs .loop

	sta {1}
        
        sta WSYNC
        adc #7
        eor #$f
        
        asl
        asl
        asl
        asl
        sta {2}
        sta HMOVE
        lda #0
        sta {2}
           
    ENDM
; Now we're going to drive the TV signal properly.
; Assuming NTSC standards, we need the following:
; - 3 scanlines of VSYNC
; - 37 blank lines
; - 192 visible scanlines
; - 30 blank lines

; We'll use the VSYNC register to generate the VSYNC signal,
; and the VBLANK register to force a blank screen above
; and below the visible frame (it'll look letterboxed on
; the emulator, but not on a real TV)


; at time t a bar can have a command to set its position, velocity
; and duration.



; Let's define a variable to hold the starting color
; at memory address $81

; The CLEAN_START macro zeroes RAM and registers
Start	CLEAN_START

NextFrame
; Enable VBLANK (disable output)
	lda #2
        sta VBLANK
; At the beginning of the frame we set the VSYNC bit...
	lda #2
	sta VSYNC
; And hold it on for 3 scanlines...
	sta WSYNC
	sta WSYNC
	sta WSYNC
; Now we turn VSYNC off.
	lda #0
	sta VSYNC

	; VBLANK - Game Logic Here
        
        lda #1
        clc
        adc Time
        sta Time
        lda #0
        adc Time+1
        sta Time+1



        ; Control the location of the paddles
        
        ldx PinkPad
        
        bit SWCHA
        bmi .NotRight
	inx
.NotRight
	bvs .NotLeft
        dex
.NotLeft
	
        cpx #140
        bcs .DontMove
	stx PinkPad
.DontMove


	ldx #36
LVBlank	sta WSYNC	; accessing WSYNC stops the CPU until next scanline
	dex		; decrement X
	bne LVBlank	; loop until X == 0

	lda #$aa
        sta COLUP0
        lda #$5c
        sta COLUP1
        
        lda #2
        sta ENAM0
        sta ENAM1
        
        lda #$30
        sta NUSIZ0
        sta NUSIZ1
        
        ;lda #$53
        ;sta PinkPad

	lda #50
        sta BlueX
	lda BlueX
        cmp #$15*7 + 8
        bcc .NoBlueReset
        lda #3
        sta BlueX
.NoBlueReset

        SET_SPRT RESM0, HMM0, BlueX
        

	lda #90
        sta PinkX
	lda PinkX
        cmp #$15*7 + 8
        bcc .NoPinkReset
        lda #3
        sta PinkX
.NoPinkReset
        
	SET_SPRT RESM1, HMM1, PinkX
        
        lda #$00
        sta GRP0
        sta GRP1
        
; Re-enable output (disable VBLANK)
	lda #0
        sta VBLANK
        
        lda #$00
        sta PinkVel
        sta BlueVel
        
        lda #0
        sta PinkIdx
        sta BlueIdx
        lda #1
        sta PinkCtr
        sta BlueCtr
        
        ldy BlueIdx
        lda SongDataBlueTimes,y
        sta BlueCtr
        lda SongDataBlueVel,y
        sta HMM0
        
        ldy PinkIdx
        lda SongDataPinkTimes,y
        sta BlueCtr
        lda SongDataPinkVel,y
        sta HMM1
        

        
        
; 192 scanlines are visible
	ldx #170
	lda #1
ScanLoop        

        
        ldy PinkIdx
	dec PinkCtr
        bne .1
        iny
        lda SongDataPinkTimes,y
        sta PinkCtr
        lda SongDataPinkVel,y
        sta HMM1
.1:
        sty PinkIdx

        
        ;sta WSYNC
        
        ldy BlueIdx
	dec BlueCtr
        bne .2
        iny
        lda SongDataBlueTimes,y
        sta BlueCtr
        lda SongDataBlueVel,y
        sta HMM0
.2:
	sty BlueIdx
        
        sta WSYNC
	sta HMOVE
     
        dex
	bne ScanLoop
        
        
        stx ENAM0
        stx ENAM1
        
        ; TODO: Activate the paddles here
                
        lda #$ff
        ;sta GRP0
        sta GRP1
        
        ;SET_SPRT RESP0, HMP0, BluePad
        SET_SPRT RESP1, HMP1, PinkPad
        
	ldx #22
HudLoop        
	sta WSYNC
        
        ; TODO: Draw the paddles here
        
        
        dex
        bne HudLoop

; Enable VBLANK again
	lda #2
        sta VBLANK
; 30 lines of overscan to complete the frame
	ldx #30
LVOver	sta WSYNC
	dex
	bne LVOver
	
; Go back and do another frame
	jmp NextFrame
        
	org $fffc
	.word Start
	.word Start
        
